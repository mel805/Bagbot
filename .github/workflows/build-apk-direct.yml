name: Build APK Direct (Sans Expo)

on:
  workflow_dispatch:
  push:
    branches:
      - 'cursor/android-app-dashboard-sync-fbf6'
    paths:
      - 'BagBotApp/**'

jobs:
  build:
    name: Build APK Sans Expo
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¦ Install dependencies
        working-directory: ./BagBotApp
        run: npm install --legacy-peer-deps

      - name: ðŸ› ï¸ Remove Expo plugins from Gradle
        working-directory: ./BagBotApp/android
        run: |
          echo "ðŸ”§ Modification des fichiers Gradle pour supprimer Expo..."
          
          # Backup
          cp settings.gradle settings.gradle.backup
          cp app/build.gradle app/build.gradle.backup
          
          # CrÃ©er build.gradle root simplifiÃ©
          cat > build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "35.0.0"
                  minSdkVersion = 24
                  compileSdkVersion = 34
                  targetSdkVersion = 34
                  kotlinVersion = "1.9.25"
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath('com.android.tools.build:gradle:8.2.0')
                  classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
                  maven { url 'https://www.jitpack.io' }
              }
          }
          EOF
          
          # Simplifier settings.gradle
          cat > settings.gradle << 'EOF'
          rootProject.name = 'BagBotApp'
          include ':app'
          EOF
          
          # Simplifier app/build.gradle avec MainActivity
          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          
          android {
              namespace 'com.bagbot.dashboard'
              compileSdk 34
              buildToolsVersion "35.0.0"
              
              defaultConfig {
                  applicationId 'com.bagbot.dashboard'
                  minSdkVersion 24
                  targetSdkVersion 34
                  versionCode 2
                  versionName "1.1.0"
                  multiDexEnabled true
              }
              
              signingConfigs {
                  debug {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
              }
              
              buildTypes {
                  debug {
                      signingConfig signingConfigs.debug
                  }
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled false
                      shrinkResources false
                  }
              }
              
              packaging {
                  resources {
                      pickFirsts += ['lib/x86/libc++_shared.so', 'lib/x86_64/libc++_shared.so', 'lib/armeabi-v7a/libc++_shared.so', 'lib/arm64-v8a/libc++_shared.so']
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              implementation 'androidx.multidex:multidex:2.0.1'
          }
          EOF
          
          # CrÃ©er MainActivity simple
          mkdir -p app/src/main/java/com/bagbot/dashboard
          cat > app/src/main/java/com/bagbot/dashboard/MainActivity.kt << 'EOFKT'
          package com.bagbot.dashboard
          
          import android.os.Bundle
          import android.webkit.WebView
          import android.webkit.WebViewClient
          import android.webkit.WebSettings
          import androidx.appcompat.app.AppCompatActivity
          
          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  
                  val webView = WebView(this)
                  setContentView(webView)
                  
                  webView.webViewClient = WebViewClient()
                  webView.settings.apply {
                      javaScriptEnabled = true
                      domStorageEnabled = true
                      databaseEnabled = true
                  }
                  
                  // Charger le dashboard web
                  webView.loadUrl("https://bagbot-dashboard.onrender.com")
              }
          }
          EOFKT
          
          # CrÃ©er AndroidManifest simple
          mkdir -p app/src/main/res/values
          cat > app/src/main/AndroidManifest.xml << 'EOFMANIFEST'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              
              <application
                  android:allowBackup="true"
                  android:icon="@android:drawable/sym_def_app_icon"
                  android:label="BAG Bot Dashboard"
                  android:theme="@style/Theme.AppCompat.DayNight.NoActionBar"
                  android:usesCleartextTraffic="true">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOFMANIFEST
          
          # VÃ©rifier que le keystore debug existe
          if [ ! -f "app/debug.keystore" ]; then
            keytool -genkey -v -keystore app/debug.keystore \
              -storepass android -alias androiddebugkey \
              -keypass android -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi

      - name: ðŸ—ï¸ Build APK
        working-directory: ./BagBotApp/android
        run: |
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon --stacktrace 2>&1 | tee build.log
          
          # Si release Ã©choue, essayer debug
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Build release Ã©chouÃ©, tentative en debug..."
            ./gradlew assembleDebug --no-daemon --stacktrace
          fi

      - name: ðŸ“¦ Find and rename APK
        id: find_apk
        working-directory: ./BagBotApp/android/app/build/outputs/apk
        run: |
          # Chercher l'APK
          if [ -f "release/app-release.apk" ]; then
            APK_FILE="release/app-release.apk"
            APK_NAME="bagbot-dashboard-v1.1.0-release.apk"
            BUILD_TYPE="release"
          elif [ -f "debug/app-debug.apk" ]; then
            APK_FILE="debug/app-debug.apk"
            APK_NAME="bagbot-dashboard-v1.1.0-debug.apk"
            BUILD_TYPE="debug"
          else
            echo "âŒ Aucun APK trouvÃ©!"
            find . -name "*.apk"
            exit 1
          fi
          
          cp $APK_FILE $APK_NAME
          
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          
          # Info APK
          ls -lh $APK_NAME
          
          echo "âœ… APK crÃ©Ã©: $APK_NAME"

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bagbot-dashboard-apk
          path: ./BagBotApp/android/app/build/outputs/apk/${{ steps.find_apk.outputs.apk_name }}
          retention-days: 90

      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸŽ‰ Build TerminÃ©!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APK GÃ©nÃ©rÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- **Fichier:** ${{ steps.find_apk.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ steps.find_apk.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** 1.1.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ TÃ©lÃ©chargement" >> $GITHUB_STEP_SUMMARY
          echo "L'APK est disponible dans les artifacts de cette exÃ©cution." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. TÃ©lÃ©chargez l'APK depuis les artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. TransfÃ©rez sur votre appareil Android" >> $GITHUB_STEP_SUMMARY
          echo "3. Activez 'Sources inconnues'" >> $GITHUB_STEP_SUMMARY
          echo "4. Installez l'APK" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¾ Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ./BagBotApp/android/build.log
          retention-days: 7
