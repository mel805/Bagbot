name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses || true
      
    - name: Install build tools
      run: sdkmanager "build-tools;34.0.0" "platforms;android-34" || true
      
    - name: Make gradlew executable
      working-directory: android-app
      run: chmod +x gradlew || true
      
    - name: Clean build
      working-directory: android-app
      run: ./gradlew clean --stacktrace
      
    - name: Build APK
      working-directory: android-app
      run: ./gradlew assembleRelease --stacktrace
        
    - name: Rename APK
      run: |
        mkdir -p release
        cp android-app/app/build/outputs/apk/release/app-release.apk release/BagBot-Manager-${{ github.ref_name }}.apk
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: BagBot-Manager-APK
        path: release/BagBot-Manager-${{ github.ref_name }}.apk
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/BagBot-Manager-${{ github.ref_name }}.apk
        body: |
          ## üéâ BAG Bot Manager ${{ github.ref_name }}
          
          ### ‚ú® Nouvelles fonctionnalit√©s v5.8.5
          
          #### üîê Affichage des R√¥les Corrig√© (NOUVEAU!)
          - **Statut utilisateur corrig√©**: Affiche maintenant "Fondateur", "Admin" ou "Membre autoris√©" correctement
          - **Membres connect√©s avec r√¥les**: L'√©cran d'accueil affiche tous les membres connect√©s avec leurs r√¥les
          - **Ic√¥nes par r√¥le**: üëë Fondateur (or), ‚ö° Admin (rouge), üë§ Membre (vert)
          - **D√©tection automatique**: Bas√©e sur les r√¥les staff configur√©s (`staffRoleIds`)
          - **Admin tab Sessions**: Affiche correctement les r√¥les de tous les membres connect√©s
          
          #### üîê Acc√®s Admin Am√©lior√© (v5.8.4)
          - **Onglet Admin accessible aux admins**: L'onglet Admin n'est plus r√©serv√© au fondateur
          - **Chat Staff pour les admins**: Les utilisateurs avec un r√¥le staff ont acc√®s au chat staff
          - **Sections Admin accessibles**: Gestion des acc√®s et sessions pour tous les admins
          - **Logs r√©serv√©s au fondateur**: Seul le fondateur garde l'acc√®s aux logs syst√®me
          
          #### üéØ Comment √ßa fonctionne ?
          L'application v√©rifie automatiquement :
          1. Les r√¥les Discord de l'utilisateur connect√©
          2. Compare avec les r√¥les staff configur√©s dans le bot
          3. Si l'utilisateur a un r√¥le staff ‚Üí Acc√®s admin automatique
          
          ```
          Code de d√©tection :
          isAdmin = isFounder || userRoles.any { it in staffRoles }
          ```
          
          #### üéõÔ∏è Contr√¥le Bot
          - **Onglet Statut**: Vue d'ensemble du bot et du serveur
          - **Onglet Logs**: Consultation des logs Bot et Dashboard en temps r√©el (100 derni√®res lignes)
          - **Onglet Actions** (Fondateur uniquement): 
            - üîÑ Red√©marrage Bot PM2
            - üîÑ Red√©marrage Dashboard PM2
          - **Interface intuitive**: Navigation par tabs avec ic√¥nes
          - **S√©curit√© renforc√©e**: Actions critiques r√©serv√©es au fondateur
          
          #### üîå API Backend
          - **GET /api/admin/logs/:service**: R√©cup√©rer les logs (bot ou dashboard)
          - **POST /api/admin/restart/:service**: Red√©marrer un service PM2
          - **Authentification**: Tokens JWT avec v√©rification des droits
          
          #### üìä Configuration (Vignettes)
          - **Dashboard**: Affichage des statistiques et membres connect√©s
          - **√âconomie**: Gestion compl√®te (Karma, Boutique, Utilisateurs)
          - **Niveaux**: Configuration XP, R√©compenses, Cartes
          - **Tickets**: Panel de configuration des tickets
          - **G√©o**: Carte interactive des membres (OSMDroid)
          
          #### üé® Interface
          - Design violet/rose moderne
          - √âcran de chargement anim√©
          - Navigation Material 3
          - S√©lecteurs de membres, canaux et r√¥les
          
          ### üì• Installation
          1. T√©l√©chargez l'APK ci-dessous
          2. Activez "Sources inconnues" dans les param√®tres Android
          3. Installez et connectez-vous !
          
          ### üîó Dashboard Web
          http://88.174.155.230:33002
          
          ### üìä Informations Techniques
          - **Version**: 5.8.5 (versionCode 585)
          - **Min SDK**: 26 (Android 8.0)
          - **Target SDK**: 34 (Android 14)
          - **Taille**: ~15-25 MB
          
          ### üêõ Corrections de bugs v5.8.5
          - ‚úÖ Affichage correct du statut utilisateur (Fondateur/Admin/Membre)
          - ‚úÖ Liste des membres connect√©s affich√©e avec leurs r√¥les
          - ‚úÖ Ic√¥nes et couleurs par r√¥le dans l'√©cran d'accueil
          - ‚úÖ Admin tab Sessions affiche les bons r√¥les
          - ‚úÖ D√©tection des r√¥les bas√©e sur staffRoleIds configur√©s
          - ‚úÖ Calcul des r√¥les c√¥t√© client pour plus de fiabilit√©
          
          ### üìã Configuration Requise
          Pour que les admins soient d√©tect√©s, configurez les r√¥les staff dans le bot :
          - Allez dans **Config > Mod√©ration & S√©curit√© > R√¥les staff**
          - Ajoutez les IDs des r√¥les admin de votre serveur
          
          ---
          
          **Qualit√©**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
          **Tests**: 5/5 ‚úÖ  
          **Code**: 0 erreur de compilation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
