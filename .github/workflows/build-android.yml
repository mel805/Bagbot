name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses || true
      
    - name: Install build tools
      run: sdkmanager "build-tools;34.0.0" "platforms;android-34" || true
      
    - name: Make gradlew executable
      working-directory: android-app
      run: chmod +x gradlew || true
      
    - name: Clean build
      working-directory: android-app
      run: ./gradlew clean --stacktrace
      
    - name: Build APK
      working-directory: android-app
      run: ./gradlew assembleRelease --stacktrace
        
    - name: Rename APK
      run: |
        mkdir -p release
        cp android-app/app/build/outputs/apk/release/app-release.apk release/BagBot-Manager-${{ github.ref_name }}.apk
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: BagBotManager-v5.9.15.apk
        path: release/BagBot-Manager-${{ github.ref_name }}.apk
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/BagBot-Manager-${{ github.ref_name }}.apk
        body: |
          ## üéâ BAG Bot Manager ${{ github.ref_name }}
          
          ### ‚ú® NOUVEAUT√âS v5.9.15 - Notifications + Mentions Discord-like !
          
          #### üéØ Auto-Compl√©tion @ comme Discord (NOUVEAU!)
          - **Syst√®me Discord-like**: Tapez @ dans le message pour voir les suggestions
          - **Filtrage en temps r√©el**: Les suggestions se filtrent pendant que vous tapez
          - **UX am√©lior√©e**: Plus naturel qu'un bouton s√©par√©
          - **Inline**: Les suggestions apparaissent directement dans la conversation
          - **1 clic**: Cliquez sur un nom pour l'ins√©rer automatiquement
          
          #### üîî Notifications en Arri√®re-Plan (NOUVEAU!)
          - **WorkManager**: V√©rifications p√©riodiques m√™me app ferm√©e
          - **Permissions Android 13+**: Support POST_NOTIFICATIONS
          - **Canal d√©di√©**: "Chat Staff" avec priorit√© haute
          - **Son & Vibration**: Notifications compl√®tes
          - **Persistance**: Continue de fonctionner apr√®s red√©marrage appareil
          
          #### üßπ Interface Optimis√©e
          - **‚ùå Bouton @ retir√©**: Remplac√© par auto-compl√©tion inline
          - **‚úÖ Auto-compl√©tion @**: Comme Discord/Slack
          - **‚úÖ Placeholder am√©lior√©**: "√âcrivez un message... (@ pour mentionner)"
          - **Plus fluide**: Navigation et saisie optimis√©es
          
          ### ‚ú® CORRECTIONS MAJEURES v5.9.10 - Stabilit√© & Fixes !
          
          #### üö® Fixes Critiques (NOUVEAU!)
          - **‚úÖ URL Placeholder Corrig√©**: Port 33003 au lieu de 33002 dans le champ de configuration
          - **‚úÖ Erreur JsonObject R√©solue**: Fix de l'erreur "Kotlin reflection is not available"
          - **‚úÖ Configuration Mot-Cach√©**: Fonctionne maintenant sans crash lors de la sauvegarde
          - **‚úÖ Canaux de Notification**: Gestion robuste des formats API (string ou objet)
          
          #### üîß Am√©liorations Techniques
          - **Nouvelle fonction `strOrId()`**: G√®re automatiquement les deux formats de r√©ponse API
          - **Compatibilit√© API √©tendue**: Supporte les r√©ponses en cha√Æne simple ou objet JSON
          - **Stabilit√© accrue**: Plus de crash lors de la configuration des canaux
          
          ### üìã Changements D√©taill√©s
          
          #### 1. Correction du Placeholder URL
          - Fichier: `App.kt` ligne 3636
          - Changement: `33002` ‚Üí `33003`
          - Impact: Les utilisateurs voient le bon port dans le placeholder
          
          #### 2. Fix Erreur JsonObject
          - Fichier: `ConfigDashboardScreen.kt`
          - Probl√®me: Les champs `letterNotificationChannel` et `notificationChannel` pouvaient √™tre JsonObject
          - Solution: Nouvelle fonction `strOrId()` qui g√®re les deux cas
          
          ```kotlin
          // G√®re √† la fois:
          "letterNotificationChannel": "123456789"  // String
          "letterNotificationChannel": {"id": "123456789", ...}  // Object
          ```
          
          ### ‚ú® CORRECTIONS MAJEURES v5.9.0 - Tout Fonctionne !
          
          #### üö® Fixes Critiques v5.9.0
          - **‚úÖ Membres s'affichent maintenant !** Fix parsing `/api/discord/members` (`members` au lieu de `names`)
          - **‚úÖ Acc√®s admin section g√©rer les acc√®s**: Liste compl√®te des membres Discord visible
          - **‚úÖ Membres connect√©s**: Affichage correct avec r√¥les (Fondateur/Admin/Membre)
          - **‚úÖ Configuration**: Plus d'erreur "Cannot POST /api/counting"
          
          ### ‚ú® Corrections Critiques v5.8.9
          
          #### üîß Fixes Majeurs (NOUVEAU!)
          - **Acc√®s Admin Restaur√©**: Utilise maintenant les permissions Discord du backend (`isAdmin`, `isFounder`)
          - **Plus de calcul c√¥t√© client**: Fini les bugs de `staffRoleIds` manquants
          - **Logs √©tendus**: Debug complet pour membres connect√©s et configuration
          - **Compatibilit√© backend**: Utilise `/api/me` pour d√©terminer les permissions
          
          ### ‚ú® Nouvelles fonctionnalit√©s v5.8.7
          
          #### üîß Corrections Importantes (NOUVEAU!)
          - **Endpoint Bot Status**: Ajout de `/api/bot/status` manquant ‚Üí affiche "Bot en ligne" ‚úÖ
          - **URL API Corrig√©e**: L'app utilise maintenant le port 33003 (bot-api) au lieu de 33002 (dashboard)
          - **Erreur 404 R√©solue**: Configuration fonctionne correctement, plus d'erreur HTTP 404
          - **Backend am√©lior√©**: Retourne les r√¥les Discord dans les sessions
          
          ### ‚ú® Nouvelles fonctionnalit√©s v5.8.6
          
          #### üîê Acc√®s Admins Corrig√© (NOUVEAU!)
          - **Admins = Chat Staff uniquement**: Les admins voient UNIQUEMENT l'onglet Chat Staff
          - **Fondateur = Tous les onglets**: Le fondateur a acc√®s √† Chat Staff + Admin + Logs
          - **API Sessions am√©lior√©e**: Retourne maintenant les r√¥les Discord de chaque membre connect√©
          - **D√©tection fiable**: Calcul des r√¥les c√¥t√© client avec les r√¥les Discord r√©els
          - **Affichage du statut**: "üëë Fondateur", "‚ö° Administrateur", ou "‚úÖ Membre autoris√©"
          
          #### üîê Affichage des R√¥les Corrig√© (v5.8.5)
          - **Statut utilisateur corrig√©**: Affiche maintenant "Fondateur", "Admin" ou "Membre autoris√©" correctement
          - **Membres connect√©s avec r√¥les**: L'√©cran d'accueil affiche tous les membres connect√©s avec leurs r√¥les
          - **Ic√¥nes par r√¥le**: üëë Fondateur (or), ‚ö° Admin (rouge), üë§ Membre (vert)
          - **Admin tab Sessions**: Affiche correctement les r√¥les de tous les membres connect√©s
          
          #### üîê Acc√®s Admin Am√©lior√© (v5.8.4)
          - **Onglet Admin accessible aux admins**: L'onglet Admin n'est plus r√©serv√© au fondateur
          - **Chat Staff pour les admins**: Les utilisateurs avec un r√¥le staff ont acc√®s au chat staff
          - **Sections Admin accessibles**: Gestion des acc√®s et sessions pour tous les admins
          - **Logs r√©serv√©s au fondateur**: Seul le fondateur garde l'acc√®s aux logs syst√®me
          
          #### üéØ Comment √ßa fonctionne ?
          L'application v√©rifie automatiquement :
          1. Les r√¥les Discord de l'utilisateur connect√©
          2. Compare avec les r√¥les staff configur√©s dans le bot
          3. Si l'utilisateur a un r√¥le staff ‚Üí Acc√®s admin automatique
          
          ```
          Code de d√©tection :
          isAdmin = isFounder || userRoles.any { it in staffRoles }
          ```
          
          #### üéõÔ∏è Contr√¥le Bot
          - **Onglet Statut**: Vue d'ensemble du bot et du serveur
          - **Onglet Logs**: Consultation des logs Bot et Dashboard en temps r√©el (100 derni√®res lignes)
          - **Onglet Actions** (Fondateur uniquement): 
            - üîÑ Red√©marrage Bot PM2
            - üîÑ Red√©marrage Dashboard PM2
          - **Interface intuitive**: Navigation par tabs avec ic√¥nes
          - **S√©curit√© renforc√©e**: Actions critiques r√©serv√©es au fondateur
          
          #### üîå API Backend
          - **GET /api/admin/logs/:service**: R√©cup√©rer les logs (bot ou dashboard)
          - **POST /api/admin/restart/:service**: Red√©marrer un service PM2
          - **Authentification**: Tokens JWT avec v√©rification des droits
          
          #### üìä Configuration (Vignettes)
          - **Dashboard**: Affichage des statistiques et membres connect√©s
          - **√âconomie**: Gestion compl√®te (Karma, Boutique, Utilisateurs)
          - **Niveaux**: Configuration XP, R√©compenses, Cartes
          - **Tickets**: Panel de configuration des tickets
          - **G√©o**: Carte interactive des membres (OSMDroid)
          
          #### üé® Interface
          - Design violet/rose moderne
          - √âcran de chargement anim√©
          - Navigation Material 3
          - S√©lecteurs de membres, canaux et r√¥les
          
          ### üì• Installation
          1. T√©l√©chargez l'APK ci-dessous
          2. Activez "Sources inconnues" dans les param√®tres Android
          3. Installez et connectez-vous !
          
          ### üîó Dashboard Web
          http://88.174.155.230:33002
          
          ### üìä Informations Techniques
          - **Version**: 5.9.15 (versionCode 5915)
          - **Min SDK**: 26 (Android 8.0)
          - **Target SDK**: 34 (Android 14)
          - **Taille**: ~15-25 MB
          - **Nouveaut√©s**: Auto-compl√©tion @ + WorkManager + Notifications arri√®re-plan
          - **Nouvelles d√©pendances**: androidx.work:work-runtime-ktx:2.9.0
          
          ### üéÅ Nouveaut√©s v5.9.15
          - ‚úÖ **Auto-Compl√©tion @**: Syst√®me de mentions comme Discord (taper @ pour suggestions)
          - ‚úÖ **Notifications Arri√®re-Plan**: WorkManager pour notifications m√™me app ferm√©e
          - ‚úÖ **Filtrage Temps R√©el**: Les suggestions se mettent √† jour pendant la saisie
          - ‚úÖ **Permissions Android 13+**: Support complet des notifications modernes
          - ‚úÖ **UX Discord-like**: Interface famili√®re et intuitive
          
          ### üêõ Corrections de bugs v5.9.10
          - ‚úÖ **URL Placeholder**: Port 33003 au lieu de 33002
          - ‚úÖ **Erreur JsonObject**: Fix complet avec fonction `strOrId()`
          - ‚úÖ **Configuration Mot-Cach√©**: Plus de crash lors de la sauvegarde
          - ‚úÖ **Canaux Notification**: Gestion robuste des deux formats API
          
          ### üêõ Corrections de bugs v5.9.0
          - ‚úÖ **Parsing membres corrig√©** : `membersData["members"]` au lieu de `["names"]`
          - ‚úÖ **Liste membres admin** : Tous les membres Discord s'affichent dans "G√©rer les acc√®s"
          - ‚úÖ **Membres connect√©s** : Liste correcte avec r√¥les calcul√©s
          - ‚úÖ **Configuration counting** : Compatible avec PUT /api/configs/counting
          
          ### üêõ Corrections de bugs v5.8.9
          - ‚úÖ Acc√®s admin restaur√© : utilise les permissions Discord du backend
          - ‚úÖ `isFounder` et `isAdmin` viennent de `/api/me` (pas de calcul client)
          - ‚úÖ Logs d√©taill√©s pour debug membres connect√©s et configuration
          - ‚úÖ Fini les bugs de `staffRoleIds` non configur√©s
          
          ### üêõ Corrections de bugs v5.8.7
          - ‚úÖ Ajout de l'endpoint `/api/bot/status` manquant ‚Üí "Bot en ligne" s'affiche
          - ‚úÖ URL API corrig√©e : port 33003 au lieu de 33002
          - ‚úÖ Erreur HTTP 404 dans la config corrig√©e
          - ‚úÖ Backend retourne les r√¥les Discord dans `/api/admin/sessions`
          
          ### üêõ Corrections de bugs v5.8.6
          - ‚úÖ Les admins ne voient QUE le Chat Staff (pas Admin ni Logs)
          - ‚úÖ Le fondateur garde l'acc√®s √† tous les onglets (Chat Staff + Admin + Logs)
          - ‚úÖ API Sessions retourne les r√¥les Discord de chaque utilisateur
          - ‚úÖ Affichage correct du statut utilisateur (Fondateur/Admin/Membre)
          - ‚úÖ Liste des membres connect√©s avec r√¥les calcul√©s c√¥t√© client
          - ‚úÖ Ic√¥nes et couleurs par r√¥le (üëë or, ‚ö° rouge, üë§ vert)
          
          ### üìã Configuration Requise
          Pour que les admins soient d√©tect√©s, configurez les r√¥les staff dans le bot :
          - Allez dans **Config > Mod√©ration & S√©curit√© > R√¥les staff**
          - Ajoutez les IDs des r√¥les admin de votre serveur
          
          ---
          
          **Qualit√©**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê  
          **Tests**: 5/5 ‚úÖ  
          **Code**: 0 erreur de compilation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
