name: Build Android APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ“¦ Install dependencies
      working-directory: ./BagBotApp
      run: |
        npm install --legacy-peer-deps

    - name: ğŸ”¨ Build APK with EAS Build
      working-directory: ./BagBotApp
      run: |
        # Installer EAS CLI
        npm install -g eas-cli
        
        # Build APK (nÃ©cessite compte Expo)
        # RemplacÃ© par un build manuel avec Gradle
        
    - name: ğŸ”¨ Generate Android project  
      working-directory: ./BagBotApp
      run: |
        npx expo prebuild --platform android --clean

    - name: ğŸ—ï¸ Build APK Debug (sans signature)
      working-directory: ./BagBotApp/android
      run: |
        chmod +x gradlew
        # Build debug APK (fonctionne mieux que release avec Expo)
        ./gradlew assembleDebug --no-daemon

    - name: ğŸ“¦ Renommer APK
      working-directory: ./BagBotApp/android/app/build/outputs/apk/debug
      run: |
        mv app-debug.apk bag-bot-dashboard-v${{ github.ref_name }}.apk
        ls -lh *.apk

    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: bag-bot-dashboard-apk
        path: BagBotApp/android/app/build/outputs/apk/debug/*.apk
        retention-days: 90

    - name: ğŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: BagBotApp/android/app/build/outputs/apk/debug/*.apk
        generate_release_notes: true
        body: |
          ## ğŸ‰ BAG Bot Dashboard Mobile ${{ github.ref_name }}
          
          ### âœ¨ Nouvelles FonctionnalitÃ©s
          
          - ğŸ‘¤ **RÃ©cupÃ©ration automatique des pseudos Discord** au premier lancement
          - âœï¸ **Modification du pseudo** Ã  tout moment via le bouton crayon
          - ğŸ’¬ **Chat staff avec vrais pseudos Discord**
          - ğŸ“Š **Monitoring serveur** en temps rÃ©el (CPU, RAM, Disque, Uptime)
          - ğŸ”„ **Gestion Ã  distance** (RedÃ©marrage dashboard/bot, vidage cache, reboot serveur)
          
          ### ğŸ“± Installation
          
          1. **TÃ©lÃ©chargez l'APK** ci-dessous
          2. **Activez "Sources inconnues"** sur Android :
             - ParamÃ¨tres â†’ SÃ©curitÃ© â†’ Sources inconnues (ON)
          3. **Installez l'APK**
          4. **Au premier lancement** : entrez votre pseudo Discord (ex: "Admin#1234")
          5. **Connectez-vous** au serveur : `http://88.174.155.230:3002`
          
          ### ğŸ” Connexion
          
          - **Login :** `admin`
          - **Password :** `bagbot2024`
          
          ### ğŸ’¬ Chat Staff
          
          - Messages avec vos vrais pseudos Discord
          - Bouton âœï¸ pour modifier votre pseudo
          - RafraÃ®chissement auto toutes les 3 secondes
          - Effacement du chat possible
          
          ### ğŸ“Š Monitoring
          
          - Uptime, CPU, RAM, Disque
          - Ã‰tat Dashboard & Bot (actif/inactif)
          - Taille du cache
          - RafraÃ®chissement auto toutes les 10 secondes
          
          ### ğŸ”§ Actions Disponibles
          
          - ğŸ”„ RedÃ©marrer Dashboard
          - ğŸ¤– RedÃ©marrer Bot
          - ğŸ—‘ï¸ Vider le Cache
          - âš ï¸ Reboot Serveur (avec confirmation)
          
          ---
          
          **âš ï¸ Distribution interne uniquement - RÃ©servÃ© aux admins du serveur BAG Bot**
          
          **ğŸ“± Type :** APK Debug (non signÃ©, parfait pour distribution interne)  
          **ğŸ”— Build :** GitHub Actions (sans compte Expo requis)  
          **ğŸ“¦ Taille :** ~60 MB
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
